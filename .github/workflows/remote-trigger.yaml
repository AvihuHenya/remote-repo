name: Update Odigos Dependencies

on:   
  repository_dispatch:
    types: [enterprise-dependencies-update]
  workflow_dispatch:

jobs:
  update-dependencies:
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repository
        uses: actions/checkout@v3

      - name: Print github.event Object
        run: |
          echo "${{ toJson(github.event) }}" > event.json
          cat event.json

      - name: Extract PR Creator
        id: pr_creator
        run: echo "name=pr_creator:${{ github.event.client_payload.pr_creator }}"
      

      - name: github preperation
        id: github_preperation
        run: |
          # Set global Git configurations
          git config --global user.email "bot@keyval.dev"
          git config --global user.name "Odigos Release Bot"

          BRANCH_PREFIX="sync-dependencies-bot-"
          echo "branch_prefix=${BRANCH_PREFIX}-" >> $GITHUB_OUTPUT
          echo "branch_name=${BRANCH_PREFIX}$(date +'%Y%m%d%H%M%S')_${{ github.event.client_payload.pr_creator }}" >> $GITHUB_OUTPUT
          
          
      - name: create dependencies update pr
        id: create_dependencies_update_pr
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN}}
        run: |
          git checkout -b ${{ steps.github_preperation.outputs.branch_name }}
          git add .
          git commit -m "update Odigos dependencies"
          git push origin ${{ steps.github_preperation.outputs.branch_name }}

          PR_LINK=$(gh pr create \
            --title "chore: automatic dependencies syncer bot" \ 
            --body "Automated PR to update Odigos enterprise components after a dependency module merge.
              PR created by: @${{ github.event.client_payload.pr_creator }}"
            --base main \
            --head ${{ steps.github_preperation.outputs.branch_name }})
          echo "PR_LINK=$PR_LINK" >> $GITHUB_ENV

          # Extract PR number from PR_LINK
          PR_NUMBER=$(echo "$PR_LINK" | awk -F '/' '{print $NF}')
          echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_ENV  

      